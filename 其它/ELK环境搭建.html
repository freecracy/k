<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>ELK 环境搭建 | k8s笔记</title><meta name="description" content="just a little"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="generator" content="VuePress 2.0.0-beta.22">
    <link rel="modulepreload" href="/k/assets/app.e373aad4.js"><link rel="modulepreload" href="/k/assets/ELK环境搭建.html.621d43dc.js"><link rel="modulepreload" href="/k/assets/ELK环境搭建.html.b7d04849.js">
    <link rel="stylesheet" href="/k/assets/style.e4ee3834.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button"><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><span><a href="/k/" class=""><img class="logo" src="https://www.google.com.hk/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" alt="k8s笔记"><span class="site-name can-hide">k8s笔记</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="指南"><span class="title">指南</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="指南"><span class="title">指南</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/k/入门/基础.md" class="nav-link" aria-label="入门"><!--[--><!--]--> 入门 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="文章"><span class="title">文章</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="文章"><span class="title">文章</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/k/%E5%85%B6%E5%AE%83/%E6%9C%8D%E5%8A%A1.html" class="nav-link" aria-label="服务"><!--[--><!--]--> 服务 <!--[--><!--]--></a></li><li class="dropdown-item"><a aria-current="page" href="/k/%E5%85%B6%E5%AE%83/ELK%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="ELK 环境搭建"><!--[--><!--]--> ELK 环境搭建 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/k/%E5%85%B6%E5%AE%83/proto3.html" class="nav-link" aria-label="proto3"><!--[--><!--]--> proto3 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/k/%E5%85%B6%E5%AE%83/Makefile.html" class="nav-link" aria-label="Makefile"><!--[--><!--]--> Makefile <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="其它"><span class="title">其它</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="其它"><span class="title">其它</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a class="nav-link external" href="https://clickhouse.tech/docs/zh/" rel="noopener noreferrer" target="_blank" aria-label="clickHouse"><!--[--><!--]--> clickHouse <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://etcd.io" rel="noopener noreferrer" target="_blank" aria-label="etcd"><!--[--><!--]--> etcd <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://www.typescriptlang.org" rel="noopener noreferrer" target="_blank" aria-label="ts"><!--[--><!--]--> ts <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://grafana.com/oss/" rel="noopener noreferrer" target="_blank" aria-label="grafana"><!--[--><!--]--> grafana <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://www.rust-lang.org/zh-CN/" rel="noopener noreferrer" target="_blank" aria-label="rust"><!--[--><!--]--> rust <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://www.codepile.net" rel="noopener noreferrer" target="_blank" aria-label="代码编辑平台"><!--[--><!--]--> 代码编辑平台 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://github.com/filebrowser/filebrowser" rel="noopener noreferrer" target="_blank" aria-label="文件服务器"><!--[--><!--]--> 文件服务器 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a class="nav-link external" href="http://wpa.qq.com/msgrd?v=3&amp;uin=295984047&amp;site=qq&amp;menu=yes" rel="noopener noreferrer" target="_blank" aria-label="联系我"><!--[--><!--]--> 联系我 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="指南"><span class="title">指南</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="指南"><span class="title">指南</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/k/入门/基础.md" class="nav-link" aria-label="入门"><!--[--><!--]--> 入门 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="文章"><span class="title">文章</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="文章"><span class="title">文章</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/k/%E5%85%B6%E5%AE%83/%E6%9C%8D%E5%8A%A1.html" class="nav-link" aria-label="服务"><!--[--><!--]--> 服务 <!--[--><!--]--></a></li><li class="dropdown-item"><a aria-current="page" href="/k/%E5%85%B6%E5%AE%83/ELK%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="ELK 环境搭建"><!--[--><!--]--> ELK 环境搭建 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/k/%E5%85%B6%E5%AE%83/proto3.html" class="nav-link" aria-label="proto3"><!--[--><!--]--> proto3 <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/k/%E5%85%B6%E5%AE%83/Makefile.html" class="nav-link" aria-label="Makefile"><!--[--><!--]--> Makefile <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="其它"><span class="title">其它</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="其它"><span class="title">其它</span><span class="right arrow"></span></button><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a class="nav-link external" href="https://clickhouse.tech/docs/zh/" rel="noopener noreferrer" target="_blank" aria-label="clickHouse"><!--[--><!--]--> clickHouse <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://etcd.io" rel="noopener noreferrer" target="_blank" aria-label="etcd"><!--[--><!--]--> etcd <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://www.typescriptlang.org" rel="noopener noreferrer" target="_blank" aria-label="ts"><!--[--><!--]--> ts <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://grafana.com/oss/" rel="noopener noreferrer" target="_blank" aria-label="grafana"><!--[--><!--]--> grafana <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://www.rust-lang.org/zh-CN/" rel="noopener noreferrer" target="_blank" aria-label="rust"><!--[--><!--]--> rust <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://www.codepile.net" rel="noopener noreferrer" target="_blank" aria-label="代码编辑平台"><!--[--><!--]--> 代码编辑平台 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><li class="dropdown-item"><a class="nav-link external" href="https://github.com/filebrowser/filebrowser" rel="noopener noreferrer" target="_blank" aria-label="文件服务器"><!--[--><!--]--> 文件服务器 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-links-item"><a class="nav-link external" href="http://wpa.qq.com/msgrd?v=3&amp;uin=295984047&amp;site=qq&amp;menu=yes" rel="noopener noreferrer" target="_blank" aria-label="联系我"><!--[--><!--]--> 联系我 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">入门</p><ul class=""><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E5%9F%BA%E7%A1%80.html" class="nav-link sidebar-item" aria-label="基础"><!--[--><!--]--> 基础 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E5%88%9B%E5%BB%BA%E5%92%8C%E5%8F%91%E5%B8%83%E5%BA%94%E7%94%A8.html" class="nav-link sidebar-item" aria-label="创建和发布应用"><!--[--><!--]--> 创建和发布应用 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE.html" class="nav-link sidebar-item" aria-label="安装配置"><!--[--><!--]--> 安装配置 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E6%B7%B1%E5%85%A5%E6%8E%8C%E6%8F%A1pod.html" class="nav-link sidebar-item" aria-label="深入掌握 pod"><!--[--><!--]--> 深入掌握 pod <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E6%B7%B1%E5%85%A5%E6%8E%8C%E6%8F%A1service.html" class="nav-link sidebar-item" aria-label="深入掌握 service"><!--[--><!--]--> 深入掌握 service <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6.html" class="nav-link sidebar-item" aria-label="核心组件运行机制"><!--[--><!--]--> 核心组件运行机制 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E9%9B%86%E7%BE%A4%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6.html" class="nav-link sidebar-item" aria-label="集群安全机制"><!--[--><!--]--> 集群安全机制 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E7%BD%91%E7%BB%9C.html" class="nav-link sidebar-item" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E5%AD%98%E5%82%A8.html" class="nav-link sidebar-item" aria-label="存储"><!--[--><!--]--> 存储 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86.html" class="nav-link sidebar-item" aria-label="集群管理"><!--[--><!--]--> 集群管理 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97.html" class="nav-link sidebar-item" aria-label="开发指南"><!--[--><!--]--> 开发指南 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/k/%E5%85%A5%E9%97%A8/%E9%97%AE%E9%A2%98%E9%9B%86.html" class="nav-link sidebar-item" aria-label="问题集"><!--[--><!--]--> 问题集 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="elk-环境搭建" tabindex="-1"><a class="header-anchor" href="#elk-环境搭建" aria-hidden="true">#</a> ELK 环境搭建</h1><h2 id="es-搭建" tabindex="-1"><a class="header-anchor" href="#es-搭建" aria-hidden="true">#</a> ES 搭建</h2><h3 id="配置" tabindex="-1"><a class="header-anchor" href="#配置" aria-hidden="true">#</a> 配置</h3><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment">## 主节点+数据节点 既有主节点资格,又存储数据,主节点</span>
<span class="token key atrule">node.master</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">node.data</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token comment">## 数据节点 不参与选举,只存储数据</span>
<span class="token key atrule">node.master</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">node.data</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token comment">## 客户端节点 不会成为主节点，也不会存储数据，主要是针对海量请求的时候，可以进行负载均衡</span>
<span class="token key atrule">node.master</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">node.data</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">cluster.name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>name
<span class="token key atrule">node.name</span><span class="token punctuation">:</span> es1
<span class="token key atrule">node.master</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">node.data</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">path.data</span><span class="token punctuation">:</span> /var/data
<span class="token key atrule">path.logs</span><span class="token punctuation">:</span> /var/log
<span class="token key atrule">network.host</span><span class="token punctuation">:</span> 0.0.0.0
<span class="token key atrule">http.port</span><span class="token punctuation">:</span> <span class="token number">9200</span>
<span class="token key atrule">cluster.initial_master_nodes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;es1&quot;</span><span class="token punctuation">]</span> <span class="token comment"># 单节点部署</span>
<span class="token key atrule">bootstrap.memory_lock</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">bootstrap.system_call_filter</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">http.cors.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">http.cors.allow-origin</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
<span class="token key atrule">xpack.security.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">xpack.security.transport.ssl.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="启动" tabindex="-1"><a class="header-anchor" href="#启动" aria-hidden="true">#</a> 启动</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>bin/elasticsearch -d
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="验证" tabindex="-1"><a class="header-anchor" href="#验证" aria-hidden="true">#</a> 验证</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> http://127.0.0.1:89200
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h2 id="kibana-搭建" tabindex="-1"><a class="header-anchor" href="#kibana-搭建" aria-hidden="true">#</a> kibana 搭建</h2><h3 id="配置-1" tabindex="-1"><a class="header-anchor" href="#配置-1" aria-hidden="true">#</a> 配置</h3><p>可以下载 客户端 mac 或 windos 版直接连接服务器 es,也可以服务器部署.</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">elasticsearch.hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;http://127.0.0.1:9200&quot;</span><span class="token punctuation">]</span>
<span class="token key atrule">elasticsearch.username</span><span class="token punctuation">:</span> <span class="token string">&quot;kibana_system&quot;</span>
<span class="token key atrule">elasticsearch.password</span><span class="token punctuation">:</span> <span class="token string">&quot;password&quot;</span>
<span class="token key atrule">i18n.locale</span><span class="token punctuation">:</span> <span class="token string">&quot;zh-CN&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="启动-1" tabindex="-1"><a class="header-anchor" href="#启动-1" aria-hidden="true">#</a> 启动</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>bin/kibana
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="验证-1" tabindex="-1"><a class="header-anchor" href="#验证-1" aria-hidden="true">#</a> 验证</h3><p>浏览器打开 <a href="http://127.0.0.1:5601" target="_blank" rel="noopener noreferrer">http://127.0.0.1:5601<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 输入 elastic 密码.</p><h2 id="logstash-同步-mysql-到-es" tabindex="-1"><a class="header-anchor" href="#logstash-同步-mysql-到-es" aria-hidden="true">#</a> logstash 同步 mysql 到 ES</h2><h3 id="配置-2" tabindex="-1"><a class="header-anchor" href="#配置-2" aria-hidden="true">#</a> 配置</h3><p>需要下载 jdbc connecter 相应版本.</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>input <span class="token punctuation">{</span>
jdbc <span class="token punctuation">{</span>
jdbc_driver_library =<span class="token punctuation">&gt;</span> &quot;/mysql<span class="token punctuation">-</span>connector<span class="token punctuation">-</span>java<span class="token punctuation">-</span>5.1.49/mysql<span class="token punctuation">-</span>connector<span class="token punctuation">-</span>java<span class="token punctuation">-</span>5.1.49.jar&quot;
jdbc_driver_class =<span class="token punctuation">&gt;</span> &quot;com.mysql.jdbc.Driver&quot;
jdbc_connection_string =<span class="token punctuation">&gt;</span> &quot;jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/db&quot;
jdbc_user =<span class="token punctuation">&gt;</span> &quot;username&quot;
jdbc_password =<span class="token punctuation">&gt;</span> &quot;password&quot;
schedule =<span class="token punctuation">&gt;</span> &quot;* * * * <span class="token important">*&quot;</span>
statement =<span class="token punctuation">&gt;</span> &quot;select * from test WHERE updated_at <span class="token punctuation">&gt;</span>= <span class="token punctuation">:</span>sql_last_value&quot;
use_column_value =<span class="token punctuation">&gt;</span> true
tracking_column_type =<span class="token punctuation">&gt;</span> &quot;timestamp&quot;
tracking_column =<span class="token punctuation">&gt;</span> &quot;updated_at&quot;
last_run_metadata_path =<span class="token punctuation">&gt;</span> &quot;syncpoint_table&quot;
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


output <span class="token punctuation">{</span>
elasticsearch <span class="token punctuation">{</span>
hosts =<span class="token punctuation">&gt;</span> <span class="token punctuation">[</span><span class="token string">&quot;127.0.0.1:9200&quot;</span><span class="token punctuation">]</span>
user =<span class="token punctuation">&gt;</span> elastic
password =<span class="token punctuation">&gt;</span> password
index =<span class="token punctuation">&gt;</span> &quot;index&quot;
document_id =<span class="token punctuation">&gt;</span> &quot;%<span class="token punctuation">{</span>id<span class="token punctuation">}</span>&quot;
document_type =<span class="token punctuation">&gt;</span> &quot;type&quot;
<span class="token punctuation">}</span>
stdout <span class="token punctuation">{</span>
codec =<span class="token punctuation">&gt;</span> json_lines
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><blockquote><p>where hq_music.updated_at &gt;= :sql_last_value</p></blockquote><h3 id="启动-2" tabindex="-1"><a class="header-anchor" href="#启动-2" aria-hidden="true">#</a> 启动</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>bin/logstash
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="验证-2" tabindex="-1"><a class="header-anchor" href="#验证-2" aria-hidden="true">#</a> 验证</h3><p>kibana dev tool 中执行查询语句</p><h2 id="canal-同步-mysql-到-es" tabindex="-1"><a class="header-anchor" href="#canal-同步-mysql-到-es" aria-hidden="true">#</a> canal 同步 mysql 到 ES</h2><p>需要开启 binlog,并且 binlog 必须是 raw 模式.</p><h2 id="filebeat-日志收集" tabindex="-1"><a class="header-anchor" href="#filebeat-日志收集" aria-hidden="true">#</a> filebeat 日志收集</h2><h3 id="配置-3" tabindex="-1"><a class="header-anchor" href="#配置-3" aria-hidden="true">#</a> 配置</h3><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /var/<span class="token important">*.log</span> <span class="token comment"># 文件名没有后缀,可以用/*</span>
    <span class="token key atrule">json.keys_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">json.overwrite_keys</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">json.add_error_key</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">json.expand_keys</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;http://127.0.0.1:9200&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">&quot;elastic&quot;</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">&quot;password&quot;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">setup.ilm.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">setup.template.name</span><span class="token punctuation">:</span> <span class="token string">&quot;app-log-&quot;</span>
<span class="token key atrule">setup.template.pattern</span><span class="token punctuation">:</span> <span class="token string">&quot;app-log-*&quot;</span>
<span class="token key atrule">output.elasticsearch</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;http://127.0.0.1:9200&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">&quot;elastic&quot;</span>
  <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">&quot;password&quot;</span>
  <span class="token key atrule">index</span><span class="token punctuation">:</span> <span class="token string">&quot;app-log-%{[agent.version]}-%{+yyyy.MM.dd}&quot;</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><ul><li>需要 cat &gt;&gt; 写入日志才能生效</li><li>setup 要放前面</li></ul></blockquote><h3 id="启动-3" tabindex="-1"><a class="header-anchor" href="#启动-3" aria-hidden="true">#</a> 启动</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>./filebeat -e -c filebeat.yml
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="验证-3" tabindex="-1"><a class="header-anchor" href="#验证-3" aria-hidden="true">#</a> 验证</h3><p>kibana 中可以配置配置索引源,查看日志数据.如果日志行是普通日志则会解析成 msg 一个字段,如果是 json 字段会全部解析.</p><h2 id="监控" tabindex="-1"><a class="header-anchor" href="#监控" aria-hidden="true">#</a> 监控</h2><p>Grafana : 通过 k8s 部署 es-export 将监控 metrics 导出, prometheus 采集监控数据,grafana 定制 dashboard 展示.</p><h2 id="es-常见概念" tabindex="-1"><a class="header-anchor" href="#es-常见概念" aria-hidden="true">#</a> ES 常见概念</h2><h3 id="cluster" tabindex="-1"><a class="header-anchor" href="#cluster" aria-hidden="true">#</a> cluster</h3><p>集群是由一个或者多个相同 cluster.name 配置的节点组成,共同承担数据和负载压力,当节点数量发生变化时集群会重新分布所有数据.分为单点模式和集群模式.其中单点模式一般不推荐生产环境使用,推荐使用集群模式部署,集群模式又分为 master 节点和 data 节点由同一个节点承担</p><h3 id="node" tabindex="-1"><a class="header-anchor" href="#node" aria-hidden="true">#</a> node</h3><p>一个运行中的 ES 实例节点.祝节点负责集群范围内所有变更,如增加删除索引,增加删除节点,且不需要涉及文档级别的变更和搜索等,任何一个节点都能成为主节点.</p><h3 id="index" tabindex="-1"><a class="header-anchor" href="#index" aria-hidden="true">#</a> index</h3><p>名词,类似于 mysql 中的数据库,倒排索引 : 类似于 mysql 中的索引,可以提升检索速度.</p><h3 id="type" tabindex="-1"><a class="header-anchor" href="#type" aria-hidden="true">#</a> type</h3><p>一个索引可以包含一个或多个 type,相当于 mysql 中的表.</p><h3 id="document" tabindex="-1"><a class="header-anchor" href="#document" aria-hidden="true">#</a> document</h3><p>相当于 mysql 中的数据行.</p><h3 id="shards" tabindex="-1"><a class="header-anchor" href="#shards" aria-hidden="true">#</a> shards</h3><p>分片,是一个底层工作单元,仅保存全部数据的一部分,是数据的容器,文档保存在分片内,分片又被分配到集群内各个节点,当集群数据规模扩大或者缩小时,ES 会自动在各个节点中迁移分配,即时数据依然均匀分布在集群里.分为主分片和副分片.在索引建立的时候就确定了分片数,但是副本分片可以随时修改,默认情况下一个主分片拥有一个副本分片,相同的主分片的副本分片不会放在同一个节点.</p><ol><li>主分片 : 索引内任意一个文档都属于主分片,所以主分片数目决定着索引能保存的最大数据量</li><li>副本分片 : 只是主分片的一个拷贝,做为硬件故障时保护数据不丢失的冗余备份,并为搜索和返回文档等操作提供服务</li></ol><h3 id="写数据" tabindex="-1"><a class="header-anchor" href="#写数据" aria-hidden="true">#</a> 写数据</h3><ol><li>客户端选择一个节点发送请求,此节点称为协调节点</li><li>协调节点对写入文档进行路由,将请求转发到对应节点</li><li>对应节点主分片自身处理完毕后,需要将数据同步到副本分片</li><li>协调节点确定主分片和副本分片都处理完后,响应结果给客户端</li></ol><h3 id="写数据原理" tabindex="-1"><a class="header-anchor" href="#写数据原理" aria-hidden="true">#</a> 写数据原理</h3><p>待写入的文档并没有立马写入磁盘,首先写入 es 虚拟机堆内存中(memory cache),memory cache 中的数据默认每隔一秒会刷新到操作系统缓存中(os cache),即在操作系统内存中产生一个 segment file,同时会在 os cache 中记录 translog 日志,此时被索引到数据可以被搜索到.默认位于 os cache 中记录到 translog 日志数据会每隔 5s 写入磁盘持久化,最多丢失 5s 的数据,默认每 30 分钟或者 translog 日志文件达到一定大小值会触发 commit 操作(flush 到磁盘),会将 os cache 中 segment file 数据写入磁盘,清空和重开 translog.默认 es 被索引数据需要 1s 才会被搜索到,最多丢失 5s 数据.</p><h3 id="es-段文件合并" tabindex="-1"><a class="header-anchor" href="#es-段文件合并" aria-hidden="true">#</a> es 段文件合并</h3><p>es 中每个 shard 每隔 1 秒都会 refresh 一次,每次 refresh 都会生成一个新的 segment,按照这个速度过不了多久 segment 的数量就会爆炸,所以存在太多的 segment 是一个大问题,因为每一个 segment 都会占用文件句柄,内存资源,cpu 资源,更加重要的是每一个搜索请求都必须访问每一个 segment,这就意味着存在的 segment 越多,搜索请求就会变的更慢.</p><p>那么 elaticsearch 是如何解决这个问题呢? 实际上 elasticsearch 有一个后台进程专门负责 segment 的合并,它会把小 segments 合并成更大的 segments,然后反复这样.在合并 segments 的时候标记删除的 document 不会被合并到新的更大的 segment 里面,所有的过程都不需要我们干涉,es 会自动在索引和搜索的过程中完成,合并的 segment 可以是磁盘上已经 commit 过的索引,也可以在内存中还未 commit 的 segment.</p><p>在索引时 refresh 进程每秒会创建一个新的 segment 并且打开它使得搜索可见 merge 进程会在后台选择一些小体积的 segments,然后将其合并成一个更大的 segment,这个过程不会打断当前的索引和搜索功能.一旦 merge 完成,旧的 segments 就会被删除,新的 segment 会被 flush 到磁盘 然后会生成新的 commit point 文件,包含新的 segment 名称,并排除掉旧的 segment 和那些被合并过的小的 segment 接着新的 segment 会被打开用于搜索,最后旧的 segment 会被删除掉</p><p>说明:如果不加控制,合并一个大的 segment 会消耗比较多的 io 和 cpu 资源,同时也会搜索性能造成影响,所以默认情况下 es 已经对合并线程做了资源限额以便于它不会搜索性能造成太大影响.</p><h3 id="读数据" tabindex="-1"><a class="header-anchor" href="#读数据" aria-hidden="true">#</a> 读数据</h3><ol><li>通过文档 id 查询，会根据文档 id 进行 hash,然后直接路由到指定的分片查询</li><li>客户端发送请求到任意节点，此节点称之为协调节点</li><li>协调节点对文档 id 进行哈希路由,将请求转发到对应的节点分片,此时会使用 round-robin 随机轮询算法,在主分片以及其所有副本分片中随机选择一个,让读请求负载均衡</li><li>接受请求的节点返回文档数据给协调节点</li><li>协调节点返回数据给客户端</li></ol><h4 id="es-搜索数据过程" tabindex="-1"><a class="header-anchor" href="#es-搜索数据过程" aria-hidden="true">#</a> es 搜索数据过程</h4><ol><li>客户端发送请求到任意节点，此节点称之为协调节点</li><li>协调节点将搜索请求分发到所有的分片(主分片或者副本分片都可以)</li><li>每个 shard 将自己的搜索结果(其实就是一些文档 id 和评分数据)返回给协调节点,由协调节点进行数据的合并、排序、分页等操作,产出最终结果</li><li>接着由协调节点根据文档 id 去各个节点上拉取实际的文档数据,最终返回给客户端</li></ol><h2 id="k8s-部署" tabindex="-1"><a class="header-anchor" href="#k8s-部署" aria-hidden="true">#</a> k8s 部署</h2><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kubectl -s http://ip:port create -f es-master.yaml  <span class="token comment"># 配置 master 节点</span>
kubectl -s http://ip:port create -f es-data.yaml    <span class="token comment"># 配置 data 节点</span>
kubectl -s http://ip:port create -f es-service.yaml <span class="token comment"># 配置成可访问服务</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="es-集群" tabindex="-1"><a class="header-anchor" href="#es-集群" aria-hidden="true">#</a> ES 集群</h2><h3 id="节点配置" tabindex="-1"><a class="header-anchor" href="#节点配置" aria-hidden="true">#</a> 节点配置</h3><h4 id="master" tabindex="-1"><a class="header-anchor" href="#master" aria-hidden="true">#</a> master</h4><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">cluster.name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>name
<span class="token key atrule">node.name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span><span class="token number">1</span>
<span class="token key atrule">node.attr.rack</span><span class="token punctuation">:</span> r1
<span class="token key atrule">network.host</span><span class="token punctuation">:</span> 0.0.0.0
<span class="token key atrule">http.port</span><span class="token punctuation">:</span> <span class="token number">9200</span>
<span class="token key atrule">discovery.seed_hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;127.0.0.1:9301&quot;</span><span class="token punctuation">]</span>
<span class="token key atrule">node.master</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">node.data</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">discovery.zen.minimum_master_nodes</span><span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token key atrule">http.cors.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">http.cors.allow-origin</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
<span class="token key atrule">transport.tcp.port</span><span class="token punctuation">:</span> <span class="token number">9302</span>

<span class="token key atrule">xpack.security.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">xpack.license.self_generated.type</span><span class="token punctuation">:</span> basic
<span class="token key atrule">xpack.security.transport.ssl.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">xpack.security.transport.ssl.verification_mode</span><span class="token punctuation">:</span> certificate
<span class="token key atrule">xpack.security.transport.ssl.keystore.path</span><span class="token punctuation">:</span> certs/elastic<span class="token punctuation">-</span>certificates.p12
<span class="token key atrule">xpack.security.transport.ssl.truststore.path</span><span class="token punctuation">:</span> certs/elastic<span class="token punctuation">-</span>certificates.p12

<span class="token key atrule">bootstrap.memory_lock</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">bootstrap.system_call_filter</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h4 id="data" tabindex="-1"><a class="header-anchor" href="#data" aria-hidden="true">#</a> data</h4><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">cluster.name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>name
<span class="token key atrule">node.name</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span><span class="token number">2</span>
<span class="token key atrule">node.attr.rack</span><span class="token punctuation">:</span> r1
<span class="token key atrule">network.host</span><span class="token punctuation">:</span> 0.0.0.0
<span class="token key atrule">http.port</span><span class="token punctuation">:</span> <span class="token number">9201</span>
<span class="token key atrule">discovery.seed_hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;127.0.0.1:9300&quot;</span><span class="token punctuation">]</span>
<span class="token key atrule">cluster.initial_master_nodes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;node-1&quot;</span><span class="token punctuation">]</span>

<span class="token key atrule">node.master</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">node.data</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token key atrule">discovery.zen.minimum_master_nodes</span><span class="token punctuation">:</span> <span class="token number">1</span>

<span class="token key atrule">http.cors.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">http.cors.allow-origin</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
<span class="token key atrule">transport.tcp.port</span><span class="token punctuation">:</span> <span class="token number">9301</span>

<span class="token key atrule">xpack.security.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">xpack.license.self_generated.type</span><span class="token punctuation">:</span> basic
<span class="token key atrule">xpack.security.transport.ssl.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">xpack.security.transport.ssl.verification_mode</span><span class="token punctuation">:</span> certificate
<span class="token key atrule">xpack.security.transport.ssl.keystore.path</span><span class="token punctuation">:</span> certs/elastic<span class="token punctuation">-</span>certificates.p12
<span class="token key atrule">xpack.security.transport.ssl.truststore.path</span><span class="token punctuation">:</span> certs/elastic<span class="token punctuation">-</span>certificates.p12

<span class="token key atrule">bootstrap.memory_lock</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">bootstrap.system_call_filter</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="设置证书" tabindex="-1"><a class="header-anchor" href="#设置证书" aria-hidden="true">#</a> 设置证书</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>bin/elasticsearch-certutil ca <span class="token comment"># 不要输入密码</span>
bin/elasticsearch-certutil cert  --ca elastic-stack-ca.p12 <span class="token comment"># 不要输入密码</span>
<span class="token function">mv</span> elastic-certificates.p12 config/certs/ <span class="token comment"># master data 都复制该文件</span>
<span class="token function">chmod</span> <span class="token number">777</span> config/certs
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="设置密码" tabindex="-1"><a class="header-anchor" href="#设置密码" aria-hidden="true">#</a> 设置密码</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>bin/elasticsearch-setup-passwords auto
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">最近更新: </span><span class="meta-item-info">2021/8/19 下午4:41:13</span></div><!----></footer><!----><!--[--><!--]--></main></div><!----><!--]--></div>
    <script type="module" src="/k/assets/app.e373aad4.js" defer></script>
  </body>
</html>
